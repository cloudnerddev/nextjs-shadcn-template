name: Vercel Deployment Handler

on:
  issue_comment:
    types: [created, edited]

jobs:
  handle-vercel-comment:
    # Only run on PR comments from vercel[bot]
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'vercel[bot]'
    
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('pr_title', pr.data.title);
            core.setOutput('pr_author', pr.data.user.login);
            core.setOutput('pr_url', pr.data.html_url);
            
            return pr.data;

      - name: Check deployment status from Vercel comment
        id: check-status
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            
            // In-progress indicators - if ANY of these are present, deployment is not complete
            const inProgressIndicators = [
              'building',
              'inspecting',
              'queued',
              'initializing'
            ];
            
            // Vercel bot failure indicators (check status badge URL for reliability)
            const failureIndicators = [
              'status/error.svg',
              'failed',
              'build error',
              '‚ùå',
              'deployment failed',
              'build failed',
              'canceled'
            ];
            
            // Vercel bot success indicators
            const successIndicators = [
              'status/ready.svg',
              '‚úÖ'
            ];
            
            let status = 'unknown';
            
            // First check if any deployment is still in progress
            const isInProgress = inProgressIndicators.some(indicator => comment.includes(indicator));
            
            if (isInProgress) {
              status = 'in_progress';
              console.log('Deployment still in progress, skipping...');
            } else {
              // Check for failures
              const hasFailed = failureIndicators.some(indicator => comment.includes(indicator));
              
              if (hasFailed) {
                status = 'failed';
              } else {
                // Check for success (only if not in progress and not failed)
                const hasSuccess = successIndicators.some(indicator => comment.includes(indicator));
                
                if (hasSuccess) {
                  status = 'success';
                }
              }
            }
            
            core.setOutput('status', status);
            console.log(`Deployment status detected: ${status}`);
            console.log(`Comment preview: ${context.payload.comment.body.substring(0, 500)}...`);

      - name: Send webhook notification on failure
        if: steps.check-status.outputs.status == 'failed'
        uses: actions/github-script@v7
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        with:
          script: |
            const webhookUrl = process.env.WEBHOOK_URL;
            
            // Check if webhook URL is configured
            if (!webhookUrl || webhookUrl.trim() === '') {
              console.log('ERROR: WEBHOOK_URL secret is not configured!');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '‚ùå **Webhook notification failed**\n\nThe `WEBHOOK_URL` secret is not configured. Please add it in repository Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret.'
              });
              
              return;
            }
            
            const payload = {
              event: "vercel_deployment_failed",
              repository: context.repo.owner + "/" + context.repo.repo,
              pr_number: context.issue.number,
              pr_title: "${{ steps.pr-details.outputs.pr_title }}",
              pr_url: "${{ steps.pr-details.outputs.pr_url }}",
              author: "${{ steps.pr-details.outputs.pr_author }}",
              branch: "${{ steps.pr-details.outputs.head_ref }}",
              target_branch: "${{ steps.pr-details.outputs.base_ref }}",
              vercel_comment: context.payload.comment.body,
              vercel_comment_url: context.payload.comment.html_url,
              timestamp: context.payload.comment.created_at
            };
            
            console.log('Sending webhook notification for failed deployment...');
            console.log('Payload:', JSON.stringify(payload, null, 2));
            
            try {
              const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });
              
              if (!response.ok) {
                console.log(`Webhook response: ${response.status} ${response.statusText}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `‚ö†Ô∏è **Webhook notification failed**\n\nStatus: ${response.status} ${response.statusText}`
                });
              } else {
                console.log('Webhook notification sent successfully');
                
                // Add comment with webhook notification details
                const payloadSummary = {
                  event: payload.event,
                  repository: payload.repository,
                  pr_number: payload.pr_number,
                  pr_title: payload.pr_title,
                  author: payload.author,
                  branch: payload.branch,
                  target_branch: payload.target_branch
                };
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `üîî **Webhook notification sent**\n\nVercel deployment failed. Notification sent to webhook.\n\n<details>\n<summary>Payload details</summary>\n\n\`\`\`json\n${JSON.stringify(payloadSummary, null, 2)}\n\`\`\`\n\n</details>`
                });
              }
            } catch (error) {
              console.log(`Webhook request failed: ${error.message}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå **Webhook notification failed**\n\nError: ${error.message}`
              });
            }

      - name: Enable auto-merge on success (main branch only)
        if: |
          steps.check-status.outputs.status == 'success' &&
          steps.pr-details.outputs.base_ref == 'main'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            
            console.log(`Processing auto-merge for PR #${prNumber}`);
            
            // Get PR details
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const prNodeId = pr.data.node_id;
            const isDraft = pr.data.draft;
            
            // If PR is a draft, convert it to ready for review first
            if (isDraft) {
              console.log(`PR #${prNumber} is a draft. Converting to ready for review...`);
              
              try {
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    markPullRequestReadyForReview(input: {
                      pullRequestId: $pullRequestId
                    }) {
                      pullRequest {
                        isDraft
                      }
                    }
                  }
                `, {
                  pullRequestId: prNodeId
                });
                
                console.log(`PR #${prNumber} marked as ready for review`);
              } catch (draftError) {
                console.log(`Failed to convert draft: ${draftError.message}`);
              }
            }
            
            // Enable auto-merge using GraphQL
            try {
              await github.graphql(`
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `, {
                pullRequestId: prNodeId,
                mergeMethod: 'SQUASH'
              });
              
              console.log(`Auto-merge enabled successfully for PR #${prNumber}`);
              
              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'üöÄ **Auto-merge enabled!**\n\nVercel deployment succeeded. This PR will be automatically squash-merged once all required checks pass.'
              });
              
            } catch (error) {
              console.log(`Failed to enable auto-merge: ${error.message}`);
              
              // If auto-merge fails for any reason, try direct merge
              // Common reasons: "Auto-merge is not allowed", "Pull request is in clean status"
              console.log('Auto-merge failed. Attempting direct merge...');
              
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                
                console.log(`PR #${prNumber} merged successfully via direct merge`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: '‚úÖ **Merged!**\n\nVercel deployment succeeded. This PR has been automatically squash-merged.'
                });
                
              } catch (mergeError) {
                console.log(`Direct merge also failed: ${mergeError.message}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: '‚ö†Ô∏è **Auto-merge failed**\n\nVercel deployment succeeded, but merge failed: ' + mergeError.message + '\n\nPlease merge manually.'
                });
              }
            }
